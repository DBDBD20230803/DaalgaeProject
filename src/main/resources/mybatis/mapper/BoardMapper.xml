<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.daalgae.daalgaeproject.board.dao.BoardMapper">

    <resultMap type="BoardDTO" id="boardResultMap">
        <id property="postCode" column="POST_CODE"/>
        <result property="postSort" column="POST_SORT"/>
        <result property="postTitle" column="POST_TITLE"/>
        <result property="postContent" column="POST_CONTENT"/>
        <result property="postDate" column="POST_DATE"/>
        <association property="refMemCode" resultMap="memberResultMap"/>
    </resultMap>

    <resultMap type="MemberDTO" id="memberResultMap">
        <id property="memCode" column="MEM_CODE"/>
        <result property="memId" column="MEM_ID"/>
        <result property="memPwd" column="MEM_PWD"/>
        <result property="memName" column="MEM_NAME"/>
        <result property="memBirth" column="MEM_BIRTH"/>
        <result property="memEmail" column="MEM_EMAIL"/>
        <result property="memAdrs" column="MEM_ADRS"/>
        <result property="memAdresDetail" column="MEM_ADRS_DETAIL"/>
        <result property="memWithdrawal" column="MEM_WITHDRAWAL"/>
        <result property="memDogGum" column="MEM_DOG_GUM"/>
        <result property="memRole" column="MEM_ROLE"/>
        <result property="memStatus" column="MEM_BAN_STATUS"/>
        <result property="mailAuth" column="MAIL_AUTH"/>
        <result property="mailKey" column="MAIL_KEY"/>
    </resultMap>

    <resultMap type="ReplyDTO" id="replyResultMap">
        <id property="replyCode" column="POST_REPLY_CODE"/>
        <result property="replyCon" column="POST_REPLY_CON"/>
        <result property="replyDate" column="POST_REPLY_DATE"/>
        <association property="refMemCode" resultMap="memberResultMap"/>
        <association property="refPostCode" resultMap="boardResultMap"/>
    </resultMap>

    <resultMap type="AttachmentDTO" id="attachmentFileResultMap">
        <id property="attachCode" column="ATTACH_CODE_SEQ"/>
        <result property="attachOriginName" column="ATTACH_ORIGIN_NAME"/>
        <result property="attachDbName" column="ATTACH_DB_NAME"/>
        <result property="attachThumbAddr" column="ATTACH_THUMB_ADDR"/>
        <result property="attachOriginAddr" column="ATTACH_ORIGIN_ADDR"/>
        <association property="refPostCode" resultMap="boardResultMap"/>
    </resultMap>

    <select id="selectTotalCount" resultType="_int" parameterType="java.lang.String">
        SELECT  /* com.daalgae.thymeleafspringboot.board.dao.BoardMapper#selectTotalCount() */
                COUNT(*)
          FROM  POST_INFO A
        <if test="searchCondition == 'refMemCode'">
            JOIN MEM_INFO B ON(A.MEM_CODE = B.MEM_CODE)
        </if>
        <where>
            <if test="searchCondition == 'postSort'">
                A.POST_SORT = #{ searchValue }
            </if>
            <if test="searchCondition == 'refMemCode'">
                B.MEM_NAME LIKE CONCAT('%', #{ searchValue }, '%')
            </if>
            <if test="searchCondition == 'postTitle'">
                A.POST_TITLE LIKE CONCAT('%', #{ searchValue }, '%')
            </if>
            <if test="searchCondition == 'postContent'">
                A.POST_CONTENT LIKE CONCAT('%', #{ searchValue }, '%')
            </if>
        </where>
    </select>

    <select id="selectBoardList" resultMap="boardResultMap">
        SELECT  /* com.daalgae.thymeleafspringboot.board.dao.BoardMapper#selectBoardList() */
                A.POST_CODE
                , A.POST_SORT
                , A.POST_TITLE
                , A.POST_CONTENT
                , A.POST_DATE
                , C.MEM_ID
          FROM (
                SELECT  B.POST_CODE
                        , B.POST_SORT
                        , B.POST_TITLE
                        , B.POST_CONTENT
                        , B.POST_DATE
                        , B.REF_POST_WRITER
                  FROM  POST_INFO B
                <if test="searchCondition == 'postSort'">
                    JOIN POST_INFO C ON(B.POST_SORT = C.POST_SORT)
                </if>
                <if test="searchCondition == 'refMemCode'">
                    JOIN MEM_INFO C ON(B.REF_POST_WRITER = C.MEM_CODE)
                </if>
                <where>
                    <if test="searchCondition == 'postSort'">
                        C.POST_SORT = #{ searchValue }
                    </if>
                    <if test="searchCondition == 'refMemCode'">
                        C.MEM_ID LIKE CONCAT('%', #{ searchValue }, '%')
                    </if>
                    <if test="searchCondition == 'postTitle'">
                        B.POST_TITLE LIKE CONCAT('%', #{ searchValue }, '%')
                    </if>
                    <if test="searchCondition == 'postContent'">
                        B.POST_CONTENT LIKE CONCAT('%', #{ searchValue }, '%')
                    </if>
                </where>
                ) A
            JOIN  MEM_INFO C ON(A.REF_POST_WRITER = C.MEM_CODE)
            ORDER BY B.POST_CODE DESC
            LIMIT  #{ startRow }, 10
    </select>

    <select id="selectBoardDetail" resultMap="boardResultMap">
        SELECT  /* com.daalgae.thymeleafspringboot.board.dao.BoardMapper#selectBoardDetail() */
                 A.POST_CODE
                 , A.POST_TITLE
                 , A.POST_CONTENT
                 , A.MEM_CODE
                 , B.MEM_ID
                 , A.POST_DATE
          FROM  POST_INFO A
          JOIN  MEM_INFO B ON (A.MEM_CODE = B.MEM_CODE)
           AND  A.POST_CODE = #{ no }
    </select>

    <select id="selectReplyList" resultMap="replyResultMap">
        SELECT  /* com.daalgae.thymeleafspringboot.board.dao.BoardMapper#selectReplyList() */
                 A.POST_REPLY_CODE
                 , A.POST_CODE
                 , A.POST_REPLY_CON
                 , A.POST_REPLY_WRITER
                 , A.POST_REPLY_DATE
                 , B.MEM_CODE
                 , B.MEM_ID
          FROM  POST_REPLY A
          JOIN  MEM_INFO B ON (A.POST_REPLY_WRITER = B.MEM_CODE)
         WHERE   A.POST_CODE = #{ refBoardNo }
        ORDER BY A.POST_REPLY_CODE
    </select>

    <insert id="insertReply">
        INSERT /* com.daalgae.thymeleafspringboot.board.dao.BoardMapper#insertReply() */
        INTO POST_REPLY   (
                           POST_CODE
                         , POST_REPLY_CON
                         , POST_REPLY_WRITER
                         )
        VALUES  (
                #{ refBoardNo }
                , #{ body }
                , #{ writerMemberNo }
                )
    </insert>

    <delete id="deleteReply" parameterType="_int">
        DELETE  /* com.daalgae.thymeleafspringboot.board.dao.BoardMapper#deleteReply() */
          FROM  POST_REPLY
         WHERE  POST_REPLY_CODE = #{ replyNo }
    </delete>

    <insert id="insertBoard" parameterType="_int">
        INSERT /* com.daalgae.thymeleafspringboot.board.dao.BoardMapper#insertBoard() */
        INTO POST_INFO      (
                              POST_SORT
                            , POST_TITLE
                            , POST_CONTENT
                            , MEM_CODE
                            )
        VALUES  (
                  #{ categoryCode }
                , #{ title }
                , #{ body }
                , #{ writerMemberNo }
                )
    </insert>

    <insert id="insertAttachment" parameterType="_int">
        INSERT /* com.daalgae.thymeleafspringboot.board.dao.BoardMapper#insertAttachment() */
        INTO ATTACHMENT_FILE    (
                                  POST_CODE
                                , ATTACH_ORIGIN_NAME
                                , ATTACH_DB_NAME
                                , ATTACH_ORIGIN_ADDR
                                , ATTACH_THUMB_ADDR
                                )
        VALUES  (
                  #{ refBoardNo }
                , #{ originalName }
                , #{ savedName }
                , #{ savePath }
                , #{ thumbnailPath }
                )
    </insert>

    <select id="selectThumbnailDetail" resultMap="boardResultMap">
        SELECT /* com.daalgae.thymeleafspringboot.board.dao.BoardMapper#selectThumbnailDetail() */
               A.POST_CODE
             , A.POST_TITLE
             , A.POST_CONTENT
             , A.POST_CONTENT
             , B.MEM_ID
             , A.POST_DATE
             , C.ATTACHMENT_NO
             , C.ATTACH_CODE_SEQ
             , C.ATTACH_DB_NAME
             , C.ATTACH_ORIGIN_ADDR
             , C.ATTACH_THUMB_ADDR
        FROM POST_INFO A
         JOIN MEM_INFO B ON (A.MEM_CODE = B.MEM_CODE)
         JOIN ATTACHMENT_FILE C ON (A.POST_CODE = C.POST_CODE)
        WHERE A.POST_CODE = #{ no }
    </select>

</mapper>

